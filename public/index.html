<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="light" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="referrer" content="no-referrer" />
  <meta name="description" content="IPv4 / IPv6 connectivity test. Check your public IPs and network readiness." />
  <title>IPv4 / IPv6 Test | JSW</title>
  <style>
    :root{
      --bg:#fff; --fg:#000; --muted:#333; --line:#000; --soft:#e6e6e6;
      --mono: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;
      --sans: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","PingFang SC","Microsoft YaHei",sans-serif;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:var(--sans)}
    a{color:inherit}
    .top{
      border-bottom:1px solid var(--line);
      padding:10px 12px;
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
      font-size:14px;
    }
    .brand{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .brand strong{font-weight:900}
    .pill{border:1px solid var(--line); border-radius:999px; padding:6px 10px; background:#f6f6f6; font-size:12px}
    .wrap{max-width:920px;margin:0 auto;padding:16px 12px 28px}
    h1{margin:10px 0 6px; font-size:24px; font-weight:900}
    .sub{margin:0 0 14px; color:var(--muted); font-size:14px; line-height:1.6}
    .bar{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0 14px}
    button{
      background:#000;color:#fff;border:0;border-radius:8px;padding:10px 14px;font-size:14px;cursor:pointer
    }
    button:focus{outline:3px solid #000;outline-offset:2px}
    select{
      border:1px solid var(--line); border-radius:8px; padding:9px 10px; background:#fff; color:#000;
      font-size:14px;
    }
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:820px){.grid{grid-template-columns:1fr 1fr 1fr}}
    .card{border:1px solid var(--line); border-radius:12px; padding:12px}
    .k{margin:0 0 6px; font-size:12px; color:var(--muted); letter-spacing:.02em}
    .row{display:flex; align-items:baseline; justify-content:space-between; gap:10px}
    .v{margin:0; font-size:16px; font-weight:900; word-break:break-all}
    .mono{font-family:var(--mono)}
    .meta{margin-top:6px; font-size:12px; color:var(--muted); line-height:1.5}
    .tag{font-weight:900}
    .ok{color:#0a7a2f}
    .bad{color:#b00020}
    .warn{color:#8a5a00}
    details{margin-top:14px}
    pre{border:1px solid var(--line); border-radius:12px; padding:12px; overflow:auto; font-size:12px; line-height:1.5}
  </style>
</head>
<body>
  <nav class="top" aria-label="Top">
    <div class="brand">
      <strong class="mono">JSW</strong>
      <span class="pill"><span id="host" class="mono"></span></span>
      <span class="pill" id="statePill">…</span>
    </div>
    <div class="brand">
      <label class="mono" for="langSel" style="font-size:12px;color:var(--muted)">LANG</label>
      <select id="langSel" aria-label="Language">
        <option value="en">English</option>
        <option value="zh-Hans">简体中文</option>
        <option value="zh-Hant">繁體中文</option>
      </select>
    </div>
  </nav>

  <main class="wrap" role="main">
    <h1 id="title">IPv4 / IPv6 Test</h1>
    <p class="sub" id="subtitle">Check whether your network supports IPv4/IPv6 and view your public IPs.</p>

    <div class="bar">
      <button id="btn">Replay</button>
    </div>

    <section class="grid" aria-label="Results">
      <div class="card" aria-live="polite">
        <p class="k" id="kV4">IPv4 record</p>
        <div class="row">
          <p class="v"><span class="tag" id="sV4">…</span></p>
          <p class="v mono" id="ipV4">-</p>
        </div>
        <div class="meta mono" id="mV4">-</div>
      </div>

      <div class="card" aria-live="polite">
        <p class="k" id="kV6">IPv6 record</p>
        <div class="row">
          <p class="v"><span class="tag" id="sV6">…</span></p>
          <p class="v mono" id="ipV6">-</p>
        </div>
        <div class="meta mono" id="mV6">-</div>
      </div>

      <div class="card" aria-live="polite">
        <p class="k" id="kDS">Dual stack</p>
        <div class="row">
          <p class="v"><span class="tag" id="sDS">…</span></p>
          <p class="v mono" id="ipDS">-</p>
        </div>
        <div class="meta mono" id="mDS">-</div>
      </div>
    </section>

    <details>
      <summary id="dbgTitle">Debug</summary>
      <pre id="raw">（empty）</pre>
    </details>
  </main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const T = {
    en: {
      title: "Test your IPv4 / IPv6 connectivity.",
      subtitle: "Check whether your network supports IPv4/IPv6 and view your public IPs.",
      replay: "Replay",
      dbg: "Debug",
      labels: { v4: "IPv4 record", v6: "IPv6 record", ds: "Dual stack" },
      state: { pending: "pending", done: "done" },
      status: { pass: "PASS", fail: "FAIL", warn: "WARN" },
      expected: { v4: "expected ipv4", v6: "expected ipv6" },
      failed: "Failed to fetch"
    },
    "zh-Hans": {
      title: "测试你的 IPv4 / IPv6 连通性",
      subtitle: "快速查看你的网络是否支持 IPv4/IPv6，并展示公网出口地址。",
      replay: "重新测试",
      dbg: "调试信息",
      labels: { v4: "IPv4 记录", v6: "IPv6 记录", ds: "双栈" },
      state: { pending: "测试中", done: "完成" },
      status: { pass: "通过", fail: "失败", warn: "警告" },
      expected: { v4: "预期 ipv4", v6: "预期 ipv6" },
      failed: "请求失败"
    },
    "zh-Hant": {
      title: "測試你的 IPv4 / IPv6 連通性",
      subtitle: "快速查看你的網路是否支援 IPv4/IPv6，並顯示公網出口位址。",
      replay: "重新測試",
      dbg: "除錯資訊",
      labels: { v4: "IPv4 記錄", v6: "IPv6 記錄", ds: "雙棧" },
      state: { pending: "測試中", done: "完成" },
      status: { pass: "通過", fail: "失敗", warn: "警告" },
      expected: { v4: "預期 ipv4", v6: "預期 ipv6" },
      failed: "請求失敗"
    }
  };

  function detectLang() {
    const L = ((navigator.languages && navigator.languages[0]) || navigator.language || "en").toLowerCase();
    if (L.startsWith("zh")) {
      const hant = /tw|hk|mo|hant/.test(L);
      return hant ? "zh-Hant" : "zh-Hans";
    }
    return "en";
  }

  function applyLang(lang) {
    const t = T[lang] || T.en;
    document.documentElement.lang = lang === "zh-Hans" ? "zh-CN" : (lang === "zh-Hant" ? "zh-TW" : "en");
    $("title").textContent = t.title;
    $("subtitle").textContent = t.subtitle;
    $("btn").textContent = t.replay;
    $("dbgTitle").textContent = t.dbg;
    $("kV4").textContent = t.labels.v4;
    $("kV6").textContent = t.labels.v6;
    $("kDS").textContent = t.labels.ds;
  }

  function setState(lang, key) {
    const t = T[lang] || T.en;
    $("statePill").textContent = t.state[key] || key;
  }

  function tag(el, kind, text) {
    el.className = "tag " + (kind === "ok" ? "ok" : kind === "warn" ? "warn" : "bad");
    el.textContent = text;
  }

  async function fetchJSON(url, timeoutMs) {
    const ac = new AbortController();
    const t = setTimeout(() => ac.abort(), timeoutMs);
    const t0 = performance.now();
    try {
      const r = await fetch(url + (url.includes("?") ? "&" : "?") + "ts=" + Date.now(), { cache: "no-store", signal: ac.signal });
      const txt = await r.text();
      const t1 = performance.now();
      if (!r.ok) throw new Error("HTTP " + r.status);
      return { ms: (t1 - t0), data: JSON.parse(txt) };
    } finally {
      clearTimeout(t);
    }
  }

  function showResult(lang, which, kind, ip, fam, ms, note) {
    const t = T[lang] || T.en;
    const s = which === "v4" ? $("sV4") : which === "v6" ? $("sV6") : $("sDS");
    const ipEl = which === "v4" ? $("ipV4") : which === "v6" ? $("ipV6") : $("ipDS");
    const m = which === "v4" ? $("mV4") : which === "v6" ? $("mV6") : $("mDS");

    tag(s, kind, kind === "ok" ? t.status.pass : kind === "warn" ? t.status.warn : t.status.fail);
    ipEl.textContent = ip || "-";
    const parts = [];
    if (typeof ms === "number" && isFinite(ms)) parts.push(ms.toFixed(1) + " ms");
    if (fam) parts.push(fam);
    if (note) parts.push(note);
    m.textContent = parts.length ? parts.join(" · ") : "-";
  }

  const langSel = $("langSel");
  let lang = detectLang();
  langSel.value = lang;
  applyLang(lang);

  $("host").textContent = location.hostname;

  const endpoints = {
    v4: "https://test-v4.jsw.ac.cn/api/ip",
    v6: "https://test-v6.jsw.ac.cn/api/ip",
    ds: "/api/ip"
  };

  async function run() {
    const t = T[lang] || T.en;
    setState(lang, "pending");
    $("raw").textContent = "（empty）";

    showResult(lang, "v4", "warn", "-", "", NaN, "…");
    showResult(lang, "v6", "warn", "-", "", NaN, "…");
    showResult(lang, "ds", "warn", "-", "", NaN, "…");

    const pack = { ts: new Date().toISOString() };
    const timeout = 5000;

    // dual (same origin)
    try {
      const { ms, data } = await fetchJSON(endpoints.ds, timeout);
      pack.dual = data;
      showResult(lang, "ds", "ok", data.ip || "", data.family || "", ms, data.host ? ("host=" + data.host) : "");
    } catch (e) {
      pack.dual_error = String(e && e.message ? e.message : e);
      showResult(lang, "ds", "bad", "", "", NaN, pack.dual_error);
    }

    // v4 + v6 parallel
    await Promise.allSettled([
      (async () => {
        try {
          const { ms, data } = await fetchJSON(endpoints.v4, timeout);
          pack.v4 = data;
          const ok = (data.family === "ipv4");
          showResult(lang, "v4", ok ? "ok" : "warn", data.ip || "", data.family || "", ms, ok ? "" : t.expected.v4);
        } catch (e) {
          pack.v4_error = String(e && e.message ? e.message : e);
          showResult(lang, "v4", "bad", "", "", NaN, t.failed);
        }
      })(),
      (async () => {
        try {
          const { ms, data } = await fetchJSON(endpoints.v6, timeout);
          pack.v6 = data;
          const ok = (data.family === "ipv6");
          showResult(lang, "v6", ok ? "ok" : "warn", data.ip || "", data.family || "", ms, ok ? "" : t.expected.v6);
        } catch (e) {
          pack.v6_error = String(e && e.message ? e.message : e);
          showResult(lang, "v6", "bad", "", "", NaN, t.failed);
        }
      })()
    ]);

    $("raw").textContent = JSON.stringify(pack, null, 2);
    setState(lang, "done");
  }

  $("btn").addEventListener("click", run);
  langSel.addEventListener("change", () => {
    lang = langSel.value;
    applyLang(lang);
    run();
  });

  run();
})();
</script>
</body>
</html>
