<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="light" />
  <meta name="theme-color" content="#ffffff" />
  <title>JSW IPv4 / IPv6 检测</title>
  <style>
    html,body{margin:0;padding:0;background:#fff;color:#000;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","PingFang SC","Microsoft YaHei",sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:20px}
    h1{font-size:22px;margin:0 0 12px}
    .sub{font-size:14px;line-height:1.6;margin:0 0 18px;opacity:.85}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0 18px}
    button{background:#000;color:#fff;border:0;border-radius:10px;padding:10px 14px;font-size:14px;cursor:pointer}
    button:focus{outline:3px solid #000;outline-offset:2px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:780px){.grid{grid-template-columns:1fr 1fr}}
    .card{border:1px solid #000;border-radius:14px;padding:14px}
    .k{font-size:12px;opacity:.8;margin:0 0 6px}
    .v{font-size:16px;margin:0 0 8px;word-break:break-all}
    .small{font-size:12px;opacity:.8;margin:0}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .ok{font-weight:700}
    .bad{font-weight:700}
  </style>
</head>
<body>
<main class="wrap" role="main">
  <h1>JSW IPv4 / IPv6 检测</h1>
  <p class="sub">
    机制：主站（双栈）+ 一个仅 A 记录探针（IPv4）+ 一个仅 AAAA 记录探针（IPv6），和 test-ipv6.com 的思路一致。:contentReference[oaicite:3]{index=3}
  </p>

  <div class="bar">
    <button id="btn">重新测试</button>
    <span class="small">当前域名：<span class="mono" id="host"></span></span>
  </div>

  <section class="grid" aria-label="测试结果">
    <div class="card" aria-live="polite">
      <p class="k">Dual Stack（主站 /api/ip）</p>
      <p class="v" id="dual">pending…</p>
      <p class="small" id="dualMeta"></p>
    </div>

    <div class="card" aria-live="polite">
      <p class="k">IPv4 DNS record（test-v4）</p>
      <p class="v" id="v4">pending…</p>
      <p class="small" id="v4Meta"></p>
    </div>

    <div class="card" aria-live="polite">
      <p class="k">IPv6 DNS record（test-v6）</p>
      <p class="v" id="v6">pending…</p>
      <p class="small" id="v6Meta"></p>
    </div>

    <div class="card" aria-live="polite">
      <p class="k">提示</p>
      <p class="small">
        IPv6-only 用户在 NAT64/DNS64/代理环境下也可能“能访问 IPv4 探针”；这是网络过渡机制导致，不一定代表你真的有原生 IPv4。:contentReference[oaicite:4]{index=4}
      </p>
    </div>
  </section>
</main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  $("host").textContent = location.hostname;

  const dualURL = `/api/ip?ts=${Date.now()}`;
  const v4URL = `https://test-v4.jsw.ac.cn/api/ip?ts=${Date.now()}`;
  const v6URL = `https://test-v6.jsw.ac.cn/api/ip?ts=${Date.now()}`;

  async function fetchJSON(url, ms) {
    const ac = new AbortController();
    const t = setTimeout(() => ac.abort(), ms);
    try {
      const r = await fetch(url, { cache: "no-store", signal: ac.signal });
      const txt = await r.text();
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      return JSON.parse(txt);
    } finally {
      clearTimeout(t);
    }
  }

  function show(el, meta, ok, ip, extra) {
    el.innerHTML = ok
      ? `<span class="ok">PASS</span> <span class="mono">${ip || "-"}</span>`
      : `<span class="bad">FAIL</span>`;
    meta.textContent = extra || "";
  }

  async function run() {
    const dual = $("dual"), dualMeta = $("dualMeta");
    const v4 = $("v4"), v4Meta = $("v4Meta");
    const v6 = $("v6"), v6Meta = $("v6Meta");

    show(dual, dualMeta, true, "pending…", "");
    show(v4, v4Meta, true, "pending…", "");
    show(v6, v6Meta, true, "pending…", "");

    const tmo = 4500;

    // 1) dual (same origin)
    fetchJSON(dualURL, tmo)
      .then(d => show(dual, dualMeta, true, d.ip, `${d.family} · host=${d.host}`))
      .catch(e => show(dual, dualMeta, false, "", String(e && e.message ? e.message : e)));

    // 2) v4 probe
    fetchJSON(v4URL, tmo)
      .then(d => show(v4, v4Meta, true, d.ip, `${d.family} · host=${d.host}`))
      .catch(e => show(v4, v4Meta, false, "", String(e && e.message ? e.message : e)));

    // 3) v6 probe
    fetchJSON(v6URL, tmo)
      .then(d => show(v6, v6Meta, true, d.ip, `${d.family} · host=${d.host}`))
      .catch(e => show(v6, v6Meta, false, "", String(e && e.message ? e.message : e)));
  }

  $("btn").addEventListener("click", run);
  run();
})();
</script>
</body>
</html>
