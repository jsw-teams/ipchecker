<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="light" />
  <meta name="theme-color" content="#ffffff" />
  <title>JSW 单域名 IPv4/IPv6 检测</title>
  <style>
    html,body{margin:0;padding:0;background:#fff;color:#000;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","PingFang SC","Microsoft YaHei",sans-serif}
    a{color:inherit}
    .wrap{max-width:900px;margin:0 auto;padding:20px}
    h1{font-size:22px;margin:0 0 12px}
    .sub{font-size:14px;line-height:1.6;margin:0 0 18px;opacity:.85}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:12px 0 18px}
    button{background:#000;color:#fff;border:0;border-radius:10px;padding:10px 14px;font-size:14px;cursor:pointer}
    button:focus{outline:3px solid #000;outline-offset:2px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:780px){.grid{grid-template-columns:1fr 1fr}}
    .card{border:1px solid #000;border-radius:14px;padding:14px}
    .k{font-size:12px;opacity:.8;margin:0 0 6px}
    .v{font-size:16px;margin:0 0 8px;word-break:break-all}
    .small{font-size:12px;opacity:.8;margin:0}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
    .ok{font-weight:700}
    .bad{font-weight:700}
    details{margin-top:12px}
    pre{border:1px solid #000;border-radius:12px;padding:12px;overflow:auto}
  </style>
</head>
<body>
  <main class="wrap" role="main">
    <h1>JSW 单域名 IPv4/IPv6 检测</h1>
    <p class="sub">
      只请求一次 <span class="mono">/api/ip</span>，以 <span class="mono">X-Forwarded-For</span> 代理链推断 IPv4/IPv6（best-effort），同时展示本次连接的权威地址。
    </p>

    <div class="bar">
      <button id="btn">刷新检测</button>
      <span class="small">当前域名：<span id="host" class="mono"></span></span>
    </div>

    <section class="grid" aria-label="检测结果">
      <div class="card" aria-live="polite">
        <p class="k">本次连接（connection.remote_addr）</p>
        <p class="v" id="conn">检测中…</p>
        <p class="small" id="connMeta"></p>
      </div>

      <div class="card" aria-live="polite">
        <p class="k">推断结果（来自 X-Forwarded-For）</p>
        <p class="v" id="guess">检测中…</p>
        <p class="small" id="guessMeta"></p>
      </div>

      <div class="card" aria-live="polite">
        <p class="k">IPv4（guess.ipv4）</p>
        <p class="v" id="v4">检测中…</p>
        <p class="small" id="v4Meta"></p>
      </div>

      <div class="card" aria-live="polite">
        <p class="k">IPv6（guess.ipv6）</p>
        <p class="v" id="v6">检测中…</p>
        <p class="small" id="v6Meta"></p>
      </div>
    </section>

    <details>
      <summary>查看原始 JSON（调试用）</summary>
      <pre id="raw">（空）</pre>
    </details>
  </main>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const elHost = $("host"), elBtn = $("btn");
  const elConn = $("conn"), elConnMeta = $("connMeta");
  const elGuess = $("guess"), elGuessMeta = $("guessMeta");
  const elV4 = $("v4"), elV4Meta = $("v4Meta");
  const elV6 = $("v6"), elV6Meta = $("v6Meta");
  const elRaw = $("raw");

  elHost.textContent = location.hostname;

  async function run() {
    elConn.textContent = "检测中…"; elConnMeta.textContent = "";
    elGuess.textContent = "检测中…"; elGuessMeta.textContent = "";
    elV4.textContent = "检测中…"; elV4Meta.textContent = "";
    elV6.textContent = "检测中…"; elV6Meta.textContent = "";
    elRaw.textContent = "（空）";

    try {
      const r = await fetch(`/api/ip?ts=${Date.now()}`, { cache: "no-store" });
      const txt = await r.text();
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = JSON.parse(txt);

      elRaw.textContent = JSON.stringify(data, null, 2);

      const c = data.connection || {};
      const g = data.guess || {};

      elConn.innerHTML = `<span class="ok">✓</span> <span class="mono">${c.ip || "-"}</span>`;
      elConnMeta.textContent = `${c.family || "unknown"}${c.port ? " · port=" + c.port : ""}`;

      elGuess.innerHTML = g.client_ip
        ? `<span class="ok">✓</span> <span class="mono">${g.client_ip}</span>`
        : `<span class="bad">✗</span> 未能从代理链推断客户端公网 IP`;
      elGuessMeta.textContent = g.note || "";

      elV4.innerHTML = g.ipv4 ? `<span class="ok">✓</span> <span class="mono">${g.ipv4}</span>` : `<span class="bad">✗</span> 未发现公网 IPv4`;
      elV4Meta.textContent = g.ipv4 ? "来自 XFF 代理链" : "可能无 IPv4 / 被隐藏 / 链路不提供";

      elV6.innerHTML = g.ipv6 ? `<span class="ok">✓</span> <span class="mono">${g.ipv6}</span>` : `<span class="bad">✗</span> 未发现公网 IPv6`;
      elV6Meta.textContent = g.ipv6 ? "来自 XFF 代理链" : "可能无 IPv6 / 被隐藏 / 链路不提供";
    } catch (e) {
      const msg = (e && e.message) ? e.message : String(e);
      elConn.innerHTML = `<span class="bad">✗</span> 失败`;
      elConnMeta.textContent = msg;
      elGuess.textContent = "失败";
      elV4.textContent = "失败";
      elV6.textContent = "失败";
    }
  }

  elBtn.addEventListener("click", run);
  run();
})();
</script>
</body>
</html>
